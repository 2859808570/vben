# SPMS 前端部署指南

## 部署概述

本文档说明如何将构建好的前端应用部署到服务器上。文件已解压到服务器路径：`/home/gf/software/spms`

## 部署步骤

### 1. 确认文件结构

确保以下文件已正确解压到 `/home/gf/software/spms` 目录：

```
/home/gf/software/spms/
├── index.html          # 入口文件
├── _app.config.js      # 应用配置文件
├── favicon.ico         # 网站图标
├── css/                # 样式文件目录
├── js/                 # JavaScript 文件目录
└── jse/                # 其他资源目录
```

### 2. 配置 Nginx

#### 2.1 创建 Nginx 配置文件

在服务器上创建或编辑 Nginx 配置文件（通常位于 `/etc/nginx/conf.d/spms.conf` 或 `/etc/nginx/sites-available/spms`）：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 修改为你的域名或 IP
    
    # 网站根目录
    root /home/gf/software/spms;
    index index.html;
    
    # 字符集
    charset utf-8;
    
    # 日志配置
    access_log /var/log/nginx/spms_access.log;
    error_log /var/log/nginx/spms_error.log;
    
    # 静态文件配置
    location / {
        try_files $uri $uri/ /index.html;
        
        # HTML 文件不缓存，确保更新后立即生效
        if ($request_filename ~* .*\.(?:htm|html)$) {
            add_header Cache-Control "private, no-store, no-cache, must-revalidate, proxy-revalidate";
        }
        
        # 静态资源缓存配置（CSS、JS、图片等）
        location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API 代理配置（如果需要）
    # 如果前端配置的 API 地址是 /api，则使用以下配置进行代理
    location /api {
        proxy_pass http://your-backend-server:port;  # 修改为实际的后端服务地址
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS 配置（如果后端未配置）
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        
        # 处理 OPTIONS 请求
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    
    # 错误页面
    error_page 404 /index.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
```

#### 2.2 如果使用 HTTPS

如果需要配置 HTTPS，添加 SSL 配置：

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL 证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    
    # SSL 优化配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 其他配置同上...
    root /home/gf/software/spms;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API 代理配置...
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 3. 启用 Nginx 配置

```bash
# 如果使用 sites-available/sites-enabled 结构
sudo ln -s /etc/nginx/sites-available/spms /etc/nginx/sites-enabled/

# 测试 Nginx 配置
sudo nginx -t

# 重新加载 Nginx 配置
sudo systemctl reload nginx
# 或者
sudo service nginx reload
```

### 4. 设置文件权限

确保 Nginx 有权限读取文件：

```bash
# 设置目录权限
sudo chown -R www-data:www-data /home/gf/software/spms
# 或者如果 Nginx 运行用户是 nginx
sudo chown -R nginx:nginx /home/gf/software/spms

# 设置文件权限
sudo chmod -R 755 /home/gf/software/spms
```

### 5. 配置防火墙（如果需要）

```bash
# 如果使用 firewalld
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

# 如果使用 ufw
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload
```

## 配置说明

### API 地址配置

前端应用的 API 地址在构建时已配置在 `_app.config.js` 文件中。如果需要修改 API 地址，有两种方式：

#### 方式一：修改 _app.config.js（推荐）

直接编辑 `/home/gf/software/spms/_app.config.js` 文件，修改其中的 API 地址：

```javascript
window.__APP_CONFIG__ = {
  VITE_GLOB_API_URL: 'https://your-api-server.com/api'
};
```

修改后刷新浏览器即可生效，无需重新构建。

#### 方式二：使用 Nginx 代理

如果 API 地址配置为 `/api`，可以使用 Nginx 代理到实际的后端服务（见上面的 Nginx 配置示例）。

### 路由模式

项目默认使用 `hash` 路由模式（URL 中包含 `#`），这种模式不需要特殊的服务器配置。

如果使用 `history` 模式，必须确保 Nginx 配置中包含：

```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

## 验证部署

1. **检查文件权限**：
   ```bash
   ls -la /home/gf/software/spms
   ```

2. **检查 Nginx 状态**：
   ```bash
   sudo systemctl status nginx
   ```

3. **测试访问**：
   - 在浏览器中访问：`http://your-server-ip` 或 `http://your-domain.com`
   - 检查浏览器控制台是否有错误
   - 测试 API 请求是否正常

4. **查看日志**：
   ```bash
   # 查看访问日志
   sudo tail -f /var/log/nginx/spms_access.log
   
   # 查看错误日志
   sudo tail -f /var/log/nginx/spms_error.log
   ```

## 常见问题

### 1. 404 错误

**问题**：访问路由时出现 404 错误

**解决**：确保 Nginx 配置中包含 `try_files $uri $uri/ /index.html;`

### 2. 静态资源加载失败

**问题**：CSS、JS 文件无法加载

**解决**：
- 检查文件路径是否正确
- 检查文件权限
- 检查 Nginx 的 `root` 配置是否正确

### 3. API 请求失败

**问题**：前端无法访问后端 API

**解决**：
- 检查 `_app.config.js` 中的 API 地址配置
- 检查 Nginx 的 API 代理配置
- 检查后端服务是否正常运行
- 检查 CORS 配置

### 4. 更新部署

**步骤**：
1. 停止 Nginx（可选，建议在低峰期更新）
2. 备份当前文件：`cp -r /home/gf/software/spms /home/gf/software/spms.backup`
3. 删除旧文件：`rm -rf /home/gf/software/spms/*`
4. 解压新文件到目录
5. 设置权限：`sudo chown -R www-data:www-data /home/gf/software/spms`
6. 重新加载 Nginx：`sudo systemctl reload nginx`

## 性能优化建议

1. **启用 Gzip 压缩**（在 Nginx 主配置文件中）：
   ```nginx
   gzip on;
   gzip_vary on;
   gzip_min_length 1024;
   gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
   ```

2. **启用浏览器缓存**（已在配置中设置）

3. **使用 CDN**：将静态资源部署到 CDN

4. **启用 HTTP/2**：在 HTTPS 配置中已包含 `http2`

## 安全建议

1. **隐藏 Nginx 版本信息**：
   ```nginx
   server_tokens off;
   ```

2. **限制请求大小**：
   ```nginx
   client_max_body_size 10M;
   ```

3. **配置安全头**：
   ```nginx
   add_header X-Frame-Options "SAMEORIGIN" always;
   add_header X-Content-Type-Options "nosniff" always;
   add_header X-XSS-Protection "1; mode=block" always;
   ```

4. **定期更新**：保持 Nginx 和系统更新

## 联系支持

如遇到问题，请检查：
1. Nginx 错误日志
2. 浏览器控制台错误
3. 网络连接状态
4. 后端服务状态
